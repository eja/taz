<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/static/css/maplibre-gl.css" rel="stylesheet">
  <style>
  body { margin: 0; padding: 0;}
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  </style>
</head>

<body>

<div id="map"></div>

<script src="/static/js/pmtiles.js"></script>
<script src="/static/js/maplibre-gl.js"></script>
<script src="/static/js/basemaps.js"></script>

<script>

const protocol = new pmtiles.Protocol();
maplibregl.addProtocol("pmtiles", protocol.tile);

let fileUrl = "{{.File}}";
if (fileUrl.substring(0,1) == "{") { fileUrl = window.location.search.slice(1); }
if (!fileUrl) {
  alert("Add ?map.pmtiles to URL");
  throw new Error("Missing file parameter");
}

const map = new maplibregl.Map({
  container: "map",
  style: {
    version: 8,
    sprite: window.location.origin+"/static/pics/light",
    sources: {
      "protomaps": {
        type: "vector",
        url: "pmtiles://" + fileUrl
      }
    },
    layers: basemaps.layers("protomaps", basemaps.namedFlavor("light"), {lang: "en"})
  },
});

const geolocate = new maplibregl.GeolocateControl({
  positionOptions: {
    enableHighAccuracy: true
  },
  trackUserLocation: true,
  showUserHeading: true
});

map.addControl(geolocate);

map.addControl(new maplibregl.NavigationControl());

let longPressTimer;
const showPopup = (e) => {
  const lat = e.lngLat.lat.toFixed(5);
  const lng = e.lngLat.lng.toFixed(5);
  const features = map.queryRenderedFeatures(e.point);

  let finalValue = null;

  const usefulFeature = features.find(f => 
    (f.properties.height !== undefined && f.properties.height !== null) || 
    (f.properties.elevation !== undefined && f.properties.elevation !== null)
  );

  if (usefulFeature) {
    if (usefulFeature.properties.height) {
      finalValue = usefulFeature.properties.height;
      finalLabel = "Height"; 
    } else if (usefulFeature.properties.elevation) {
      finalValue = usefulFeature.properties.elevation;
      finalLabel = "Elevation";
    }
  } 

  let htmlContent = `<strong>Lat:</strong> ${lat}<br><strong>Lng:</strong> ${lng}`;

  if (finalValue !== null) {
    htmlContent += `<br><strong>Ele:</strong> ${finalValue}m`;
  }

  if (features.length > 0) {
    htmlContent += `<hr>`;
    features.forEach((feature) => {
      const layer = feature.sourceLayer || "N/A";
      const kind = feature.properties.kind || "N/A";

      htmlContent += `
        <div class="feature-item">
        <span style="color:#666;">Layer:</span> <b>${layer}</b><br>
        <span style="color:#666;">Kind:</span> ${kind}
        </div>`;
    });
  } else {
    htmlContent += `<br><em>No vector features here.</em>`;
  }

  new maplibregl.Popup({ closeOnClick: false })
    .setLngLat(e.lngLat)
    .setHTML(htmlContent)
    .addTo(map);
};

const startTimer = (e) => {
  clearTimeout(longPressTimer);
  longPressTimer = setTimeout(() => {
    showPopup(e);
  }, 2000);
};

const cancelTimer = () => {
  clearTimeout(longPressTimer);
};

map.on('mousedown', startTimer);
map.on('touchstart', startTimer);

map.on('mouseup', cancelTimer);
map.on('touchend', cancelTimer);
map.on('dragstart', cancelTimer);

</script>
</body>
</html>

