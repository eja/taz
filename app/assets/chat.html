<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Room</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/bootstrap-icons.css">
</head>
<body>
<div class="modal fade" id="usernameModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <form id="usernameForm">
                    <div class="mb-3">
                        <label for="usernameInput" class="form-label">Name</label>
                        <input type="text" class="form-control" id="usernameInput" autofocus>
                    </div>
                    <button type="submit" class="btn btn-primary">Join</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Room</h1>
        <span>
            <button type="button" class="btn btn-sm btn-outline-secondary d-none d-md-inline-block mic-btn" disabled>
                <i class="bi bi-mic-mute"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary d-none d-md-inline-block speaker-btn" disabled>
                <i class="bi bi-volume-mute"></i>
            </button>
            <a href="/" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-90deg-left"></i>
            </a>
        </span>
    </div>

    <div id="chatMessages" class="mb-3" style="height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px;">
        <div class="text-center text-muted">No messages yet</div>
    </div>

    <form id="chatForm" class="mb-3">
        <div class="input-group">
            <input type="text" class="form-control" id="messageInput" placeholder="Type your message..." autocomplete="off" disabled>
            <button type="submit" class="btn btn-primary" disabled>
                <i class="bi bi-send"></i>
            </button>
        </div>
    </form>

    <div class="d-flex justify-content-center d-md-none gap-3 mt-4">
        <button type="button" class="btn btn-lg btn-outline-secondary mic-btn" disabled>
            <i class="bi bi-mic-mute"></i>
        </button>
        <button type="button" class="btn btn-lg btn-outline-secondary speaker-btn" disabled>
            <i class="bi bi-volume-mute"></i>
        </button>
    </div>
</div>

<script src="/static/js/bootstrap.bundle.min.js"></script>
<script>
let ws = null;
let audioCtx = null;
let audioStream = null;
let userName = '';
let micEnabled = false;
let speakerEnabled = false;
let micMuted = false;
let nextStartTime = 0;

document.addEventListener('DOMContentLoaded', () => {
    const modal = new bootstrap.Modal(document.getElementById('usernameModal'));
    modal.show();
    
    document.getElementById('usernameForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('usernameInput');
        userName = input.value.trim();
        
        if (!userName) {
            userName = Date.now().toString().slice(5,11);
        }

        modal.hide();
        initializeRoom();
    });
});

function initializeRoom() {
    connectWebSocket();
    setupEventListeners();
    
    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        initializeMicrophone();
    } catch (e) {}
}

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    ws = new WebSocket(protocol + window.location.host + '/room');
    
    ws.binaryType = 'arraybuffer';
    
    ws.onopen = () => {
        enableChatInput();
        addMessage('System', 'Connected', 'system');
        sendChatMessage(`${userName} joined`, 'system');
    };
    
    ws.onmessage = (event) => {
        if (typeof event.data === 'string') {
            try {
                const data = JSON.parse(event.data);
                if (data.sender !== userName) {
                    addMessage(data.sender, data.message, data.type || 'chat');
                }
            } catch (e) {
                addMessage('User', event.data, 'chat');
            }
        } else if (speakerEnabled) {
            try {
                const f32 = new Float32Array(event.data);
                const buffer = audioCtx.createBuffer(1, f32.length, audioCtx.sampleRate);
                buffer.copyToChannel(f32, 0);
                
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                
                const currentTime = audioCtx.currentTime;
                if (nextStartTime < currentTime) {
                    nextStartTime = currentTime + 0.05; 
                }
                
                source.start(nextStartTime);
                nextStartTime += buffer.duration;

            } catch (e) {
                console.error("Audio decode error", e);
            }
        }
    };
    
    ws.onclose = () => {
        disableChatInput();
        addMessage('System', 'Disconnected', 'system');
        setTimeout(connectWebSocket, 3000);
    };
}

async function initializeMicrophone() {
    try {
        const testStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        testStream.getTracks().forEach(track => track.stop());
        
        document.querySelectorAll('.mic-btn').forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-success');
        });
    } catch (error) {
        document.querySelectorAll('.mic-btn').forEach(btn => {
            btn.disabled = true;
        });
    }
}

function setupEventListeners() {
    document.getElementById('chatForm').addEventListener('submit', (e) => {
        e.preventDefault();
        sendChatMessage();
    });

    document.querySelectorAll('.mic-btn').forEach(btn => {
        btn.addEventListener('click', toggleMicrophone);
    });
    
    document.querySelectorAll('.speaker-btn').forEach(btn => {
        btn.addEventListener('click', toggleSpeaker);
    });
}

async function toggleMicrophone() {
    const btns = document.querySelectorAll('.mic-btn');
    
    if (!micEnabled) {
        try {
            audioStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            
            const source = audioCtx.createMediaStreamSource(audioStream);
            const processor = audioCtx.createScriptProcessor(4096, 1, 1);
            const muteNode = audioCtx.createGain();
            muteNode.gain.value = 0;
            
            source.connect(processor);
            processor.connect(muteNode);
            muteNode.connect(audioCtx.destination);
            
            processor.onaudioprocess = (e) => {
                if (ws && ws.readyState === WebSocket.OPEN && !micMuted) {
                    const audioData = e.inputBuffer.getChannelData(0);
                    ws.send(audioData);
                }
            };
            
            micEnabled = true;
            micMuted = false;
            
            btns.forEach(btn => {
                btn.innerHTML = '<i class="bi bi-mic"></i>';
                btn.classList.remove('btn-outline-success');
                btn.classList.add('btn-outline-success');
            });
            
            if (!speakerEnabled) {
                toggleSpeaker();
            }
            
            addMessage('System', 'Microphone enabled', 'system');
            
        } catch (error) {
            console.error(error);
            addMessage('System', 'Microphone error', 'system');
        }
    } else {
        micMuted = !micMuted;
        
        if (micMuted) {
            btns.forEach(btn => {
                btn.innerHTML = '<i class="bi bi-mic-mute"></i>';
                btn.classList.remove('btn-outline-success');
                btn.classList.add('btn-outline-secondary');
            });
            addMessage('System', 'Microphone muted', 'system');
        } else {
            btns.forEach(btn => {
                btn.innerHTML = '<i class="bi bi-mic"></i>';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-outline-success');
            });
            addMessage('System', 'Microphone unmuted', 'system');
        }
    }
}

function toggleSpeaker() {
    const btns = document.querySelectorAll('.speaker-btn');
    
    if (!speakerEnabled) {
        speakerEnabled = true;
        
        btns.forEach(btn => {
            btn.innerHTML = '<i class="bi bi-volume-up"></i>';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-outline-success');
        });
        
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        
        addMessage('System', 'Speaker enabled', 'system');
    } else {
        speakerEnabled = false;
        
        btns.forEach(btn => {
            btn.innerHTML = '<i class="bi bi-volume-mute"></i>';
            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-outline-secondary');
        });
        
        addMessage('System', 'Speaker disabled', 'system');
    }
}

function sendChatMessage(text = null, type = 'chat') {
    const input = document.getElementById('messageInput');
    const message = text || input.value.trim();
    
    if (!message || !ws || ws.readyState !== WebSocket.OPEN) return;
    
    const chatData = {
        sender: userName,
        message: message,
        type: type
    };
    
    ws.send(JSON.stringify(chatData));
    
    if (!text) {
        addMessage('You', message, 'self');
        input.value = '';
        input.focus();
    }
}

function addMessage(sender, text, type = 'chat') {
    const messagesDiv = document.getElementById('chatMessages');
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    if (messagesDiv.children.length === 1 && messagesDiv.children[0].className.includes('text-muted')) {
        messagesDiv.innerHTML = '';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-2';
    
    let badgeClass = 'bg-secondary';
    let textClass = '';
    
    if (type === 'system') {
        badgeClass = 'bg-warning text-dark';
        textClass = 'text-muted fst-italic';
    } else if (type === 'self') {
        badgeClass = 'bg-primary';
        textClass = 'text-primary';
    }
    
    messageDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <span class="badge ${badgeClass}">${escapeHtml(sender)}</span>
            <small class="text-muted">${time}</small>
        </div>
        <div class="${textClass}">${escapeHtml(text)}</div>
    `;
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function enableChatInput() {
    document.getElementById('messageInput').disabled = false;
    document.querySelector('#chatForm button').disabled = false;
    document.querySelectorAll('.speaker-btn').forEach(btn => btn.disabled = false);
}

function disableChatInput() {
    document.getElementById('messageInput').disabled = true;
    document.querySelector('#chatForm button').disabled = true;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

window.addEventListener('beforeunload', () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        sendChatMessage(`${userName} left`, 'system');
        setTimeout(() => ws.close(), 100);
    }
    if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
    }
});

(function() {
    const host = window.location.hostname;
    const protocol = window.location.protocol;
    const isLocal = host === 'localhost' || host === '127.0.0.1' || host === '::1';

    if (!isLocal && protocol === 'http:') {
        console.log("Redirecting to HTTPS...");
        window.location.href = window.location.href.replace('http:', 'https:');
    }
})();
</script>
</body>
</html>
